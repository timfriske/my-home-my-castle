#!/usr/bin/env bash

# Jqp command
# ===========
# Tim Friske <me@tifr.de>
#
# Prints nested JSON object graphs as flattened paths.
#
# Deps:: bash, env, fzf, jq

# Ensure fail-fast script execution.
shopt -os nounset pipefail errexit errtrace

function paths {
  case "${#}" in
    0) jq --raw-output -- 'paths|join(".")';;
    1)
      if [[ ! -d "${1}" && -r "${1}" ]]; then
        jq --raw-output -- 'paths|join(".")' "${1:--}"
      else
        jq --raw-output -- "$(printf '%s|paths|join(".")' "${1:-.}")"
      fi
      ;;
    *) jq --raw-output -- "$(printf '%s|paths|join(".")' "${1:-.}")" "${2:--}";;
  esac
}

function pick {
  local bindings=(
    'ctrl-a:toggle-all'
    'ctrl-z:clear-selection'
  )
  fzf --bind="$(IFS=,; printf '%s' "${bindings[*]}")" "${@}"    
}

if [[ -t 1 ]]; then
  paths "${@}" | pick --cycle --multi --exit-0
else
  paths "${@}"
fi
