#!/usr/bin/env bash

# AWS EKS Addon Latest Compat command
# ===================================
# Tim Friske <me@tifr.de>
#
# Prints the latest version of the given AWS EKS addon that is compatible with
# the given AWS EKS Kubernetes version.
#
# For example: aws-eks-addon-latest-compat aws-ebs-csi-driver 1.25
#
# Deps:: aws, bash, env, jq

# Ensure fail-fast script execution.
shopt -os nounset pipefail errexit errtrace

# Input parameters and validation:
AWS_EKS_ADDON="${1:-"${AWS_EKS_ADDON:?required}"}"
K8S_VERSION="${2:-"${K8S_VERSION:?required}"}"

# Read multi-line jq script into variable for legibility.
read -d '' -r AWS_EKS_ADDONS_QUERY <<'AWS_EKS_ADDONS_QUERY' || true
  .addons[0].addonVersions[]
  | select(
      .compatibilities[]
      | .clusterVersion==$cv 
          and .defaultVersion==true
    )
    .addonVersion
AWS_EKS_ADDONS_QUERY

aws eks describe-addon-versions --addon-name "${AWS_EKS_ADDON}" \
  | jq --raw-output --arg cv "${K8S_VERSION}" "${AWS_EKS_ADDONS_QUERY}"
