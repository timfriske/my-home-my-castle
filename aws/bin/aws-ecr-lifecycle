#!/usr/bin/env bash

# AWS ECR Lifecycle command
# =========================
# Tim Friske <me@tifr.de>
#
# Applies AWS ECR lifecycle policies from the given json file to the given
# repositories of current registry.
#
# Deps:: aws, bash, env, jq, parallel

# Ensure fail-fast script execution.
shopt -os nounset pipefail errexit errtrace

# Input parameters and validation:
POLICY_FILE="${1:-${POLICY_FILE:?required}}"
POLICY_FILE="file://${POLICY_FILE#file://}"
REPOSITORIES=("${@:2}");: "${REPOSITORIES?required}"

function apply_policy {
  local repository="${1:?repository}"
  local policy_file="${2:?policy_file}" 
  aws ecr put-lifecycle-policy \
    --repository-name "${repository}" \
    --lifecycle-policy-text "${policy_file}" \
  | jq '.+{lifecyclePolicyText:.lifecyclePolicyText|fromjson}'
}; export -f apply_policy

parallel --no-run-if-empty --keep-order -- \
apply_policy {} "${POLICY_FILE}" ::: "${REPOSITORIES[@]}"
